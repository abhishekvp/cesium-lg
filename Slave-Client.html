<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Slave Cesium</title>
    <script src="js/reconnecting-websocket.js"></script>
    <script src="js/web-config.js"></script>
    <script src="js/util.js"></script>
    <script src="http://cesiumjs.org/releases/1.22.1/Build/Cesium/Cesium.js"></script>
    <script src="js/Long.min.js"></script>
    <script src="js/ByteBufferAB.min.js"></script>
    <script src="js/ProtoBuf.min.js"></script>
    <script>
        if (typeof dcodeIO === 'undefined' || !dcodeIO.ProtoBuf) {
            throw (new Error("ProtoBuf.js is not present. Please see www/index.html for manual setup instructions."));
        }
        // Initialize ProtoBuf.js
        var ProtoBuf = dcodeIO.ProtoBuf;
        var CesiumSync = ProtoBuf.loadProtoFile("cesiumsync.proto").build("CesiumSync");
    </script>
    <style>
        @import url("http://cesiumjs.org/releases/1.22.1/Build/Cesium/Widgets/widgets.css");
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body onresize="updateFOV()">
    <div id="cesiumContainer"></div>

    <script>
        function handleCam(camVals) {

            //var camVals = JSON.parse(camStr);
            var px = camVals.lon,
                py = camVals.lat,
                pz = camVals.ht,
                heading = camVals.heading / CONFIG.camSigFigures;
            pitch = camVals.pitch / CONFIG.camSigFigures;
            roll = camVals.roll / CONFIG.camSigFigures,
                camStr = px + ',' + py + ',' + pz + ',' + heading + ',' + pitch + ',' + roll;
            console.log(camStr);
            viewer.camera.setView({
                destination: new Cesium.Cartesian3(px, py, pz),
                orientation: {
                    heading: heading,
                    pitch: pitch,
                    roll: roll
                }
            });
            viewer.camera.lookRight(yawRadians);
        }

        function handleGECam(camVals) {

            var px = camVals.lon,
                py = camVals.lat,
                pz = camVals.ht,
                heading = camVals.heading;
            pitch = camVals.pitch;
            roll = camVals.roll;
            camStr = px + ',' + py + ',' + pz + ',' + heading + ',' + pitch + ',' + roll;
            console.log(camStr);
            viewer.camera.setView({
                destination: new Cesium.Cartesian3.fromDegrees(px, py, pz),
                orientation: {
                    heading: heading,
                    pitch: pitch,
                    roll: roll
                }
            });


            viewer.camera.lookRight(yawRadians);
        }

        function handleStateChange(state) {
            viewer.scene.globe.enableLighting = state['lighting'];

        }

        function updateFOV() {
            console.log("Updating FOV for browser window size changed");
            viewer.camera.frustum.fov = toRadians(CONFIG.slaveHorizFOV / getAspectRatio());
        }


        Cesium.BingMapsApi.defaultKey = CONFIG.BingMapsKey;
        viewer = new Cesium.Viewer('cesiumContainer', {
            timeline: false,
            animation: false,
            geocoder: false,
            fullscreenButton: false,
            homeButton: false,
            baseLayerPicker: false,
            scenemodePicker: false,
            scene3DOnly: true,
            navigationHelpButton: false
        });
        updateFOV();
        var yawDegrees = getParameterByName('yaw');
        var yawRadians = toRadians(yawDegrees);




        var ws = new WebSocket(CONFIG.wsURI, 'echo-protocol');
        ws.binaryType = "arraybuffer";
        ws.onopen = function() {
            console.log("WS Master-Slave Connection Achieved");
            ws.onmessage = function(evt) {


                try {
                    // Decode the Message
                    var msg = CesiumSync.decode(evt.data);

                    if (msg.msgtype == "cam") {
                        console.log("Message-Type: Camera Update")
                        handleCam(msg);
                    } else if (msg.msgtype == "ge-cam") {
                        console.log("Message-Type: Google Earth Camera Update");
                        handleGECam(msg);

                    } else {
                        console.log("Message-Type: State Update");
                        handleStateChange(msg);
                    }
                } catch (err) {
                     console.log("Error: " + err);
                }
            };




        }
    </script>
</body>

</html>
